---
/**
 * SectionSettingsPanel - Slide-out panel for editing section settings
 * Displays settings from the section schema and allows live editing
 */

import SchemaFormField from './SchemaFormField.astro';

interface Setting {
  id: string;
  type: string;
  label: string;
  default?: unknown;
  info?: string;
  options?: { value: string; label: string }[];
}

interface Block {
  type: string;
  name: string;
  limit?: number;
  settings: Setting[];
}

interface Section {
  name: string;
  slug: string;
  settings: Setting[];
  blocks: Block[];
}

interface Props {
  projectSlug: string;
}

const { projectSlug } = Astro.props;
---

<div class="settings-panel" id="section-settings-panel" data-project-slug={projectSlug}>
  <div class="panel-backdrop" data-close-panel></div>
  <div class="panel-content">
    <header class="panel-header">
      <div class="panel-title-wrap">
        <h2 class="panel-title">Section Settings</h2>
        <span class="panel-section-name" id="panel-section-name"></span>
      </div>
      <button type="button" class="close-btn" data-close-panel aria-label="Close panel">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </header>

    <div class="panel-body" id="panel-body">
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading settings...</span>
      </div>
    </div>

    <footer class="panel-footer">
      <button type="button" class="btn btn-secondary" data-close-panel>Cancel</button>
      <button type="button" class="btn btn-primary" id="save-settings-btn">
        <span class="btn-text">Save Changes</span>
        <span class="btn-loading">
          <div class="btn-spinner"></div>
          Saving...
        </span>
      </button>
    </footer>
  </div>
</div>

<template id="settings-form-template">
  <form class="settings-form" id="section-settings-form">
    <input type="hidden" name="projectSlug" />
    <input type="hidden" name="sectionId" />
    <input type="hidden" name="sectionSlug" />

    <div class="settings-section">
      <h3 class="settings-section-title">Section Settings</h3>
      <div class="settings-fields" id="section-settings-fields"></div>
    </div>

    <div class="settings-section blocks-section" id="blocks-settings-section" style="display: none;">
      <h3 class="settings-section-title">Blocks</h3>
      <div class="blocks-container" id="blocks-container"></div>
    </div>
  </form>
</template>

<template id="block-item-template">
  <div class="block-item">
    <button type="button" class="block-header">
      <span class="block-name"></span>
      <svg class="block-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
      </svg>
    </button>
    <div class="block-settings"></div>
  </div>
</template>

<script>
  interface Setting {
    id: string;
    type: string;
    label: string;
    default?: unknown;
    info?: string;
    options?: { value: string; label: string }[];
  }

  interface Block {
    type: string;
    name: string;
    settings: Setting[];
  }

  interface SectionSchema {
    name: string;
    slug: string;
    settings: Setting[];
    blocks: Block[];
  }

  const panel = document.getElementById('section-settings-panel') as HTMLElement;
  const panelBody = document.getElementById('panel-body') as HTMLElement;
  const panelSectionName = document.getElementById('panel-section-name') as HTMLElement;
  const saveBtn = document.getElementById('save-settings-btn') as HTMLButtonElement;
  const formTemplate = document.getElementById('settings-form-template') as HTMLTemplateElement;
  const blockItemTemplate = document.getElementById('block-item-template') as HTMLTemplateElement;

  let currentSectionId: number | null = null;
  let currentSectionSlug: string | null = null;
  let currentSchema: SectionSchema | null = null;
  let currentSettings: Record<string, unknown> = {};

  // Close panel handlers
  panel.querySelectorAll('[data-close-panel]').forEach((el) => {
    el.addEventListener('click', closePanel);
  });

  // Save button handler
  saveBtn.addEventListener('click', saveSettings);

  // Listen for open panel events
  document.addEventListener('open-settings-panel', ((e: CustomEvent) => {
    const { sectionId, sectionSlug, sectionName } = e.detail;
    openPanel(sectionId, sectionSlug, sectionName);
  }) as EventListener);

  // Keyboard close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && panel.classList.contains('open')) {
      closePanel();
    }
  });

  function openPanel(sectionId: number, sectionSlug: string, sectionName: string) {
    currentSectionId = sectionId;
    currentSectionSlug = sectionSlug;
    panelSectionName.textContent = sectionName;

    panel.classList.add('open');
    document.body.style.overflow = 'hidden';

    loadSectionSchema(sectionSlug);
  }

  function closePanel() {
    panel.classList.remove('open');
    document.body.style.overflow = '';
    currentSectionId = null;
    currentSectionSlug = null;
    currentSchema = null;
    currentSettings = {};
  }

  async function loadSectionSchema(sectionSlug: string) {
    panelBody.innerHTML = `
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <span>Loading settings...</span>
      </div>
    `;

    try {
      const projectSlug = panel.dataset.projectSlug;

      // Fetch section schema (custom or library) from project API
      // This will return custom schema if it exists, otherwise library schema
      const response = await fetch(`/api/projects/sections/schema?project=${projectSlug}&sectionId=${currentSectionId}`);

      if (!response.ok) {
        throw new Error('Failed to load section schema');
      }

      const data = await response.json();
      currentSchema = data.schema;

      // Fetch current settings separately
      const settingsResponse = await fetch(`/api/library/section-schema?slug=${sectionSlug}&sectionId=${currentSectionId}`);
      if (settingsResponse.ok) {
        const settingsData = await settingsResponse.json();
        currentSettings = settingsData.currentSettings || {};
      } else {
        currentSettings = {};
      }

      renderSettingsForm();
    } catch (error) {
      panelBody.innerHTML = `
        <div class="error-state">
          <p>Failed to load section settings</p>
          <button type="button" class="btn btn-secondary" onclick="loadSectionSchema('${sectionSlug}')">
            Retry
          </button>
        </div>
      `;
    }
  }

  function renderSettingsForm() {
    if (!currentSchema) return;

    const formFragment = formTemplate.content.cloneNode(true) as DocumentFragment;
    const form = formFragment.querySelector('form') as HTMLFormElement;
    const sectionFieldsContainer = form.querySelector('#section-settings-fields') as HTMLElement;
    const blocksSection = form.querySelector('#blocks-settings-section') as HTMLElement;
    const blocksContainer = form.querySelector('#blocks-container') as HTMLElement;

    // Set hidden fields
    (form.querySelector('input[name="projectSlug"]') as HTMLInputElement).value = panel.dataset.projectSlug || '';
    (form.querySelector('input[name="sectionId"]') as HTMLInputElement).value = String(currentSectionId);
    (form.querySelector('input[name="sectionSlug"]') as HTMLInputElement).value = currentSectionSlug || '';

    // Render section settings
    currentSchema.settings.forEach((setting) => {
      const fieldHtml = createFieldHTML(setting, currentSettings[setting.id], `section-${currentSectionId}`);
      sectionFieldsContainer.insertAdjacentHTML('beforeend', fieldHtml);
    });

    // Render blocks if any
    if (currentSchema.blocks && currentSchema.blocks.length > 0) {
      blocksSection.style.display = 'block';

      currentSchema.blocks.forEach((block, index) => {
        const blockFragment = blockItemTemplate.content.cloneNode(true) as DocumentFragment;
        const blockItem = blockFragment.querySelector('.block-item') as HTMLElement;
        const blockName = blockItem.querySelector('.block-name') as HTMLElement;
        const blockSettingsContainer = blockItem.querySelector('.block-settings') as HTMLElement;
        const blockHeader = blockItem.querySelector('.block-header') as HTMLButtonElement;

        blockItem.dataset.blockType = block.type;
        blockItem.dataset.blockIndex = String(index);
        blockName.textContent = block.name;

        // Render block settings
        block.settings.forEach((setting) => {
          const blockSettings = (currentSettings as Record<string, Record<string, unknown>>)[`block_${block.type}`] || {};
          const fieldHtml = createFieldHTML(setting, blockSettings[setting.id], `block-${block.type}-${index}`);
          blockSettingsContainer.insertAdjacentHTML('beforeend', fieldHtml);
        });

        // Toggle block settings
        blockHeader.addEventListener('click', () => {
          blockItem.classList.toggle('expanded');
        });

        blocksContainer.appendChild(blockFragment);
      });
    }

    // Clear and append
    panelBody.innerHTML = '';
    panelBody.appendChild(formFragment);

    // Initialize field interactions
    initializeFieldInteractions();
  }

  function createFieldHTML(setting: Setting, value: unknown, prefix: string): string {
    const currentValue = value ?? setting.default ?? '';
    const fieldId = `${prefix}-${setting.id}`;
    const fieldName = `settings[${setting.id}]`;

    let fieldHtml = `<div class="schema-field" data-field-id="${setting.id}" data-field-type="${setting.type}">`;
    fieldHtml += `<label for="${fieldId}" class="field-label">${setting.label}</label>`;

    if (setting.info) {
      fieldHtml += `<p class="field-info">${setting.info}</p>`;
    }

    switch (setting.type) {
      case 'text':
        fieldHtml += `<input type="text" id="${fieldId}" name="${fieldName}" value="${escapeHtml(String(currentValue))}" class="field-input" data-setting-id="${setting.id}" />`;
        break;

      case 'textarea':
        fieldHtml += `<textarea id="${fieldId}" name="${fieldName}" class="field-textarea" rows="3" data-setting-id="${setting.id}">${escapeHtml(String(currentValue))}</textarea>`;
        break;

      case 'richtext':
        fieldHtml += `<textarea id="${fieldId}" name="${fieldName}" class="field-textarea field-richtext" rows="4" data-setting-id="${setting.id}">${escapeHtml(String(currentValue))}</textarea>`;
        break;

      case 'checkbox':
        const checked = Boolean(currentValue) ? 'checked' : '';
        fieldHtml += `
          <label class="field-checkbox">
            <input type="checkbox" id="${fieldId}" name="${fieldName}" ${checked} class="checkbox-input" data-setting-id="${setting.id}" />
            <span class="checkbox-toggle"></span>
            <span class="checkbox-label-text">Enabled</span>
          </label>`;
        break;

      case 'select':
        fieldHtml += `<select id="${fieldId}" name="${fieldName}" class="field-select" data-setting-id="${setting.id}">`;
        if (setting.options) {
          setting.options.forEach((opt) => {
            const selected = opt.value === currentValue ? 'selected' : '';
            fieldHtml += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
          });
        } else {
          // Default alignment options
          fieldHtml += `
            <option value="left" ${currentValue === 'left' ? 'selected' : ''}>Left</option>
            <option value="center" ${currentValue === 'center' ? 'selected' : ''}>Center</option>
            <option value="right" ${currentValue === 'right' ? 'selected' : ''}>Right</option>`;
        }
        fieldHtml += `</select>`;
        break;

      case 'range':
        const min = 0, max = 100, step = 1;
        fieldHtml += `
          <div class="field-range-wrapper">
            <input type="range" id="${fieldId}" name="${fieldName}" value="${currentValue}" min="${min}" max="${max}" step="${step}" class="field-range" data-setting-id="${setting.id}" />
            <div class="range-value">
              <input type="number" value="${currentValue}" min="${min}" max="${max}" step="${step}" class="range-number-input" data-range-target="${fieldId}" />
            </div>
          </div>`;
        break;

      case 'color':
        const colorVal = String(currentValue).startsWith('#') ? String(currentValue).slice(0, 7) : '#000000';
        fieldHtml += `
          <div class="field-color-wrapper">
            <input type="color" id="${fieldId}" name="${fieldName}" value="${colorVal}" class="color-input" data-setting-id="${setting.id}" />
            <input type="text" value="${escapeHtml(String(currentValue))}" maxlength="9" class="color-hex-input" data-color-target="${fieldId}" />
            <div class="color-swatch" style="background-color: ${currentValue}"></div>
          </div>`;
        break;

      case 'url':
        fieldHtml += `<input type="url" id="${fieldId}" name="${fieldName}" value="${escapeHtml(String(currentValue))}" placeholder="https://..." class="field-input field-url" data-setting-id="${setting.id}" />`;
        break;

      case 'image_picker':
        fieldHtml += `
          <div class="field-image-picker">
            <div class="image-preview">
              ${currentValue ? `<img src="${escapeHtml(String(currentValue))}" alt="Selected" class="preview-img" />` : `
                <div class="image-placeholder">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                  <span>No image</span>
                </div>`}
            </div>
            <input type="text" id="${fieldId}" name="${fieldName}" value="${escapeHtml(String(currentValue))}" placeholder="Image URL" class="field-input" data-setting-id="${setting.id}" />
          </div>`;
        break;

      default:
        fieldHtml += `<input type="text" id="${fieldId}" name="${fieldName}" value="${escapeHtml(String(currentValue))}" class="field-input" data-setting-id="${setting.id}" />`;
    }

    fieldHtml += `</div>`;
    return fieldHtml;
  }

  function escapeHtml(str: string): string {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function initializeFieldInteractions() {
    // Range sync with number input
    document.querySelectorAll('.field-range').forEach((range) => {
      const rangeInput = range as HTMLInputElement;
      const targetId = rangeInput.id;
      const numberInput = document.querySelector(`[data-range-target="${targetId}"]`) as HTMLInputElement;

      if (numberInput) {
        rangeInput.addEventListener('input', () => {
          numberInput.value = rangeInput.value;
        });

        numberInput.addEventListener('input', () => {
          rangeInput.value = numberInput.value;
        });
      }
    });

    // Color sync
    document.querySelectorAll('.color-input').forEach((colorInput) => {
      const input = colorInput as HTMLInputElement;
      const targetId = input.id;
      const hexInput = document.querySelector(`[data-color-target="${targetId}"]`) as HTMLInputElement;
      const swatch = hexInput?.nextElementSibling as HTMLElement;

      if (hexInput) {
        input.addEventListener('input', () => {
          hexInput.value = input.value;
          if (swatch) swatch.style.backgroundColor = input.value;
        });

        hexInput.addEventListener('input', () => {
          let val = hexInput.value;
          if (!val.startsWith('#')) val = '#' + val;
          if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
            input.value = val;
            if (swatch) swatch.style.backgroundColor = val;
          }
        });
      }
    });

    // Auto-trigger preview updates on field changes
    document.querySelectorAll('[data-setting-id]').forEach((field) => {
      field.addEventListener('change', debounce(() => {
        triggerPreviewUpdate();
      }, 500));
    });
  }

  function debounce<T extends (...args: unknown[]) => void>(fn: T, delay: number) {
    let timeout: number;
    return (...args: Parameters<T>) => {
      clearTimeout(timeout);
      timeout = window.setTimeout(() => fn(...args), delay);
    };
  }

  function triggerPreviewUpdate() {
    // Collect current settings from form
    const form = document.getElementById('section-settings-form') as HTMLFormElement;
    if (!form) return;

    const formData = new FormData(form);
    const settings: Record<string, unknown> = {};

    form.querySelectorAll('[data-setting-id]').forEach((field) => {
      const input = field as HTMLInputElement;
      const id = input.dataset.settingId;
      if (!id) return;

      if (input.type === 'checkbox') {
        settings[id] = input.checked;
      } else {
        settings[id] = input.value;
      }
    });

    // Dispatch event for preview update
    document.dispatchEvent(new CustomEvent('settings-preview-update', {
      detail: {
        sectionId: currentSectionId,
        sectionSlug: currentSectionSlug,
        settings
      }
    }));
  }

  async function saveSettings() {
    const form = document.getElementById('section-settings-form') as HTMLFormElement;
    if (!form) return;

    saveBtn.classList.add('loading');
    saveBtn.disabled = true;

    try {
      const formData = new FormData(form);
      const settings: Record<string, unknown> = {};

      form.querySelectorAll('[data-setting-id]').forEach((field) => {
        const input = field as HTMLInputElement;
        const id = input.dataset.settingId;
        if (!id) return;

        if (input.type === 'checkbox') {
          settings[id] = input.checked;
        } else {
          settings[id] = input.value;
        }
      });

      const response = await fetch('/api/projects/sections/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          projectSlug: formData.get('projectSlug'),
          sectionId: currentSectionId,
          settings
        })
      });

      const data = await response.json();

      if (data.success) {
        showToast('Settings saved', 'success');
        closePanel();

        // Trigger preview refresh
        document.dispatchEvent(new CustomEvent('settings-saved', {
          detail: { sectionId: currentSectionId, sectionSlug: currentSectionSlug }
        }));
      } else {
        showToast(data.error || 'Failed to save settings', 'error');
      }
    } catch (error) {
      showToast('Failed to save settings', 'error');
    } finally {
      saveBtn.classList.remove('loading');
      saveBtn.disabled = false;
    }
  }

  function showToast(message: string, type: 'success' | 'error') {
    const container = document.getElementById('toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => {
      toast.classList.add('fade-out');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function createToastContainer(): HTMLElement {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
    return container;
  }
</script>

<style>
  .settings-panel {
    position: fixed;
    inset: 0;
    z-index: 1000;
    visibility: hidden;
    pointer-events: none;
  }

  .settings-panel.open {
    visibility: visible;
    pointer-events: auto;
  }

  .panel-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    opacity: 0;
    transition: opacity 0.3s;
  }

  .settings-panel.open .panel-backdrop {
    opacity: 1;
  }

  .panel-content {
    position: absolute;
    inset-block: 0;
    inset-inline-end: 0;
    inline-size: min(420px, 100vw);
    background: white;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  }

  .settings-panel.open .panel-content {
    transform: translateX(0);
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1rem 1.25rem;
    border-block-end: 1px solid #e2e8f0;
    background: #f8fafc;
  }

  .panel-title-wrap {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .panel-title {
    font-size: 1rem;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
  }

  .panel-section-name {
    font-size: 0.8125rem;
    color: #6366f1;
    font-weight: 500;
  }

  .close-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    inline-size: 2rem;
    block-size: 2rem;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    color: #64748b;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
  }

  .close-btn:hover {
    background: #e2e8f0;
    color: #1e293b;
  }

  .close-btn svg {
    inline-size: 1.25rem;
    block-size: 1.25rem;
  }

  .panel-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.25rem;
  }

  .loading-state,
  .error-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 3rem 1rem;
    color: #64748b;
    text-align: center;
  }

  .loading-spinner {
    inline-size: 1.5rem;
    block-size: 1.5rem;
    border: 2px solid #e2e8f0;
    border-block-start-color: #6366f1;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .settings-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .settings-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .settings-section-title {
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    margin: 0;
    padding-block-end: 0.5rem;
    border-block-end: 1px solid #e2e8f0;
  }

  .settings-fields {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  /* Block items */
  .block-item {
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
  }

  .block-header {
    inline-size: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8fafc;
    border: none;
    cursor: pointer;
    transition: background 0.15s;
  }

  .block-header:hover {
    background: #f1f5f9;
  }

  .block-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: #1e293b;
  }

  .block-chevron {
    inline-size: 1rem;
    block-size: 1rem;
    color: #64748b;
    transition: transform 0.2s;
  }

  .block-item.expanded .block-chevron {
    transform: rotate(180deg);
  }

  .block-settings {
    display: none;
    padding: 1rem;
    border-block-start: 1px solid #e2e8f0;
  }

  .block-item.expanded .block-settings {
    display: block;
  }

  /* Panel footer */
  .panel-footer {
    display: flex;
    justify-content: flex-end;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-block-start: 1px solid #e2e8f0;
    background: #f8fafc;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
  }

  .btn-secondary {
    background: white;
    color: #475569;
    border: 1px solid #e2e8f0;
  }

  .btn-secondary:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
  }

  .btn-primary {
    background: #6366f1;
    color: white;
  }

  .btn-primary:hover {
    background: #4f46e5;
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-loading {
    display: none;
  }

  .btn.loading .btn-text {
    display: none;
  }

  .btn.loading .btn-loading {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-spinner {
    inline-size: 0.875rem;
    block-size: 0.875rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-block-start-color: white;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
  }

  /* Form field styles (duplicated for dynamic content) */
  :global(.schema-field) {
    margin-block-end: 1rem;
  }

  :global(.field-label) {
    display: block;
    font-size: 0.8125rem;
    font-weight: 500;
    color: #1e293b;
    margin-block-end: 0.25rem;
  }

  :global(.field-info) {
    font-size: 0.75rem;
    color: #64748b;
    margin: 0 0 0.5rem;
    line-height: 1.4;
  }

  :global(.field-input),
  :global(.field-textarea),
  :global(.field-select) {
    inline-size: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #1e293b;
    background: white;
    transition: border-color 0.15s, box-shadow 0.15s;
  }

  :global(.field-input:focus),
  :global(.field-textarea:focus),
  :global(.field-select:focus) {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  :global(.field-textarea) {
    resize: vertical;
    min-block-size: 4rem;
  }

  :global(.field-richtext) {
    font-family: monospace;
    font-size: 0.8125rem;
  }

  :global(.field-checkbox) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
  }

  :global(.checkbox-input) {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  :global(.checkbox-toggle) {
    position: relative;
    inline-size: 2.5rem;
    block-size: 1.25rem;
    background: #e2e8f0;
    border-radius: 9999px;
    transition: background 0.2s;
  }

  :global(.checkbox-toggle::after) {
    content: '';
    position: absolute;
    inset-block-start: 0.125rem;
    inset-inline-start: 0.125rem;
    inline-size: 1rem;
    block-size: 1rem;
    background: white;
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s;
  }

  :global(.checkbox-input:checked + .checkbox-toggle) {
    background: #6366f1;
  }

  :global(.checkbox-input:checked + .checkbox-toggle::after) {
    transform: translateX(1.25rem);
  }

  :global(.checkbox-label-text) {
    font-size: 0.875rem;
    color: #475569;
  }

  :global(.field-range-wrapper) {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  :global(.field-range) {
    flex: 1;
    block-size: 0.375rem;
    border-radius: 9999px;
    background: #e2e8f0;
    appearance: none;
    cursor: pointer;
  }

  :global(.field-range::-webkit-slider-thumb) {
    appearance: none;
    inline-size: 1rem;
    block-size: 1rem;
    background: #6366f1;
    border-radius: 50%;
    cursor: grab;
  }

  :global(.range-value) {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  :global(.range-number-input) {
    inline-size: 3.5rem;
    padding: 0.25rem 0.375rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    text-align: center;
  }

  :global(.field-color-wrapper) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  :global(.color-input) {
    inline-size: 2.5rem;
    block-size: 2.25rem;
    padding: 0.125rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    cursor: pointer;
    background: transparent;
  }

  :global(.color-hex-input) {
    flex: 1;
    padding: 0.5rem 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.375rem;
    font-family: monospace;
    font-size: 0.8125rem;
    text-transform: uppercase;
  }

  :global(.color-swatch) {
    inline-size: 2.25rem;
    block-size: 2.25rem;
    border-radius: 0.375rem;
    border: 1px solid #e2e8f0;
    flex-shrink: 0;
  }

  :global(.field-image-picker) {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  :global(.image-preview) {
    inline-size: 100%;
    aspect-ratio: 16 / 9;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  :global(.preview-img) {
    inline-size: 100%;
    block-size: 100%;
    object-fit: cover;
  }

  :global(.image-placeholder) {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    color: #94a3b8;
  }

  :global(.image-placeholder svg) {
    inline-size: 2rem;
    block-size: 2rem;
  }

  :global(.image-placeholder span) {
    font-size: 0.75rem;
  }
</style>
