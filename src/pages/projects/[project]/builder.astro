---
import Dashboard from '../../../layouts/Dashboard.astro';
import BuilderCanvas from '../../../components/builder/BuilderCanvas.astro';
import SchemaEditor from '../../../components/builder/SchemaEditor.astro';
import { getProject, getProjectSections } from '../../../lib/project/create';
import { getCollection } from 'astro:content';
import { listAllPresets } from '../../../lib/presets/apply';
import type { BuilderSection } from '../../../components/builder/builder-types';

const { project: projectSlug } = Astro.params;

const project = projectSlug ? await getProject(projectSlug, Astro.locals) : null;

if (!project) {
  return Astro.redirect('/projects');
}

// Get project sections with IDs for reordering
const projectSections = await getProjectSections(projectSlug!, Astro.locals);

// Get section metadata from content collection
const allSections = await getCollection('sections');
const sectionMap = new Map(allSections.map((s) => [s.data.slug, s.data]));

// Combine DB data with content collection metadata
const sections: BuilderSection[] = projectSections.map((ps) => {
  const sectionData = sectionMap.get(ps.sectionSlug);
  return {
    id: ps.id,
    sectionSlug: ps.sectionSlug,
    position: ps.position,
    name: sectionData?.name || ps.sectionSlug,
    category: sectionData?.category || 'unknown',
    description: sectionData?.description,
  };
});

// Get all available presets
const allPresets = await listAllPresets(Astro.locals);
---

<Dashboard title={`${project.name} - Builder`} activeNav="projects">
  <div class="mb-4">
    <a href={`/projects/${project.slug}`} class="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to Project
    </a>
  </div>

  <BuilderCanvas
    projectSlug={project.slug}
    projectName={project.name}
    sections={sections}
    appliedPreset={project.appliedPreset}
    availablePresets={allPresets}
  />

  <!-- Schema Editor Modal -->
  <SchemaEditor
    sectionId={0}
    sectionSlug=""
    projectSlug={project.slug}
  />
</Dashboard>

<script>
  // Handle schema editor button clicks
  document.addEventListener('click', async (e) => {
    const schemaBtn = (e.target as HTMLElement).closest('.schema-btn');
    if (!schemaBtn) return;

    const sectionId = (schemaBtn as HTMLElement).dataset.sectionId;
    const sectionSlug = (schemaBtn as HTMLElement).dataset.sectionSlug;
    const projectSlug = (schemaBtn as HTMLElement).dataset.projectSlug;

    if (!sectionId || !sectionSlug || !projectSlug) {
      console.error('Missing required data attributes');
      return;
    }

    // Fetch current schema (custom or library)
    try {
      const response = await fetch(`/api/projects/sections/schema?project=${projectSlug}&sectionId=${sectionId}`);
      const data = await response.json();

      if (data.success) {
        // Update the schema editor with the current schema
        const textarea = document.getElementById('schema-editor-textarea') as HTMLTextAreaElement;
        if (textarea) {
          textarea.value = JSON.stringify(data.schema, null, 2);
          textarea.dataset.sectionId = sectionId;
          textarea.dataset.sectionSlug = sectionSlug;
          textarea.dataset.projectSlug = projectSlug;

          // Update line numbers
          const event = new Event('input');
          textarea.dispatchEvent(event);
        }

        // Open the modal
        if ((window as any).schemaEditor) {
          (window as any).schemaEditor.open();
        }
      } else {
        alert('Failed to load schema: ' + (data.error || 'Unknown error'));
      }
    } catch (error) {
      console.error('Failed to load schema:', error);
      alert('Failed to load schema');
    }
  });
</script>

<style>
  /* Additional builder page styles */
</style>
